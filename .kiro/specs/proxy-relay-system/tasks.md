# 实施计划: 代理中转系统

## 概述

本实施计划将代理中转系统分为四个阶段开发，从最简单的MVP开始，逐步添加自动化监控、Web界面和高级功能。每个阶段都包含核心实现任务和可选的测试任务。

## 任务列表

### 阶段一: 最小可行产品 (MVP)

- [ ] 1. 项目初始化和基础设施
  - 创建Python项目结构
  - 设置虚拟环境和依赖管理（使用poetry或pip）
  - 配置pytest测试框架和Hypothesis
  - 创建基本的目录结构（/opt/proxy-relay, /etc/proxy-relay, /var/lib/proxy-relay, /var/log/proxy-relay）
  - _需求: 所有需求的基础_

- [ ]* 1.1 编写项目设置测试
  - 测试项目结构是否正确创建
  - 测试依赖是否正确安装

- [ ] 2. 实现配置管理器 (ConfigManager)
  - [ ] 2.1 创建数据模型类
    - 实现UpstreamProxy、ProxyConfig、MonitoringStatus等dataclass
    - 添加数据验证逻辑
    - _需求: 2.1, 7.2_

  - [ ]* 2.2 编写数据模型属性测试
    - **属性 4: 配置往返一致性**
    - **验证需求: 2.2, 5.4, 7.1, 7.3**

  - [ ] 2.3 实现YAML配置文件读写
    - 实现load_config()方法加载YAML配置
    - 实现save_config()方法保存配置到YAML
    - 实现配置文件路径管理
    - _需求: 7.1, 7.2_

  - [ ]* 2.4 编写配置文件读写单元测试
    - 测试配置加载和保存
    - 测试文件不存在的情况

  - [ ] 2.5 实现配置验证逻辑
    - 实现validate_config()方法
    - 验证端口范围（1024-65535）
    - 验证必需字段存在
    - 验证数据类型正确性
    - _需求: 2.4, 7.4_

  - [ ]* 2.6 编写配置验证属性测试
    - **属性 5: 无效配置被拒绝**
    - **验证需求: 2.4, 4.3, 7.4**

  - [ ]* 2.7 编写配置完整性属性测试
    - **属性 19: 配置文件完整性**
    - **验证需求: 7.2**

- [ ] 3. 实现sing-box配置生成和管理
  - [ ] 3.1 实现ProxyManager基础类
    - 创建ProxyManager类框架
    - 实现初始化方法
    - _需求: 1.1, 2.1_

  - [ ] 3.2 实现sing-box配置生成
    - 实现generate_singbox_config()方法
    - 根据代理配置生成inbounds、outbounds和route规则
    - 支持多端口配置
    - _需求: 1.1, 1.2, 1.3_

  - [ ]* 3.3 编写sing-box配置生成单元测试
    - 测试单端口配置生成
    - 测试多端口配置生成
    - 测试带认证的配置生成

  - [ ] 3.4 实现sing-box配置应用和重载
    - 实现apply_singbox_config()方法
    - 写入配置文件到/etc/proxy-relay/sing-box.json
    - 发送SIGHUP信号重载sing-box
    - 实现配置回滚机制
    - _需求: 2.3, 7.3_

  - [ ]* 3.5 编写配置应用单元测试
    - 测试配置文件写入
    - 测试配置回滚逻辑

- [ ] 4. 实现基本的CLI工具
  - [ ] 4.1 创建CLI命令框架
    - 使用Click或argparse创建CLI
    - 实现start、stop、status、list命令
    - _需求: 9.1, 9.2, 9.3_

  - [ ] 4.2 实现start命令
    - 加载配置文件
    - 生成sing-box配置
    - 启动sing-box进程
    - _需求: 9.1_

  - [ ] 4.3 实现stop命令
    - 发送SIGTERM信号到sing-box
    - 清理资源
    - _需求: 9.2_

  - [ ] 4.4 实现list命令
    - 读取当前配置
    - 显示所有代理端口和状态
    - _需求: 9.3_

  - [ ]* 4.5 编写CLI命令集成测试
    - 测试start命令
    - 测试stop命令
    - 测试list命令

- [ ] 5. 实现日志系统
  - [ ] 5.1 配置Python logging
    - 设置日志格式和级别
    - 配置文件日志handler
    - 实现日志轮转
    - _需求: 8.1, 8.4, 8.5_

  - [ ]* 5.2 编写日志级别属性测试
    - **属性 20: 日志级别过滤**
    - **验证需求: 8.4**

  - [ ]* 5.3 编写日志轮转属性测试
    - **属性 21: 日志文件轮转**
    - **验证需求: 8.5**

- [ ] 6. 创建配置文件模板和文档
  - 创建config.yaml.example示例文件
  - 编写基本的README文档
  - 编写快速开始指南
  - _需求: 7.5_

- [ ] 7. 第一阶段检查点
  - 确保所有测试通过
  - 手动测试基本代理功能
  - 如有问题请询问用户

### 阶段二: 自动化监控和切换

- [ ] 8. 实现SQLite数据库层
  - [ ] 8.1 创建数据库模型和表
    - 创建proxy_switch_history表
    - 创建health_check_log表
    - 创建monitoring_state表
    - 实现数据库初始化脚本
    - _需求: 8.1, 8.2_

  - [ ] 8.2 实现数据库操作类
    - 实现插入、查询、更新操作
    - 实现事务管理
    - _需求: 8.1, 8.2_

  - [ ]* 8.3 编写数据库操作单元测试
    - 测试CRUD操作
    - 测试事务回滚

- [ ] 9. 实现API客户端 (APIClient)
  - [ ] 9.1 创建API客户端基础类
    - 实现APIClient类框架
    - 支持配置多个API提供商
    - _需求: 6.1_

  - [ ] 9.2 实现91HTTP API集成
    - 实现get_new_proxy()方法
    - 构建查询参数
    - 发送HTTP GET请求
    - _需求: 6.2_

  - [ ]* 9.3 编写API请求单元测试
    - 使用requests-mock模拟API响应
    - 测试请求参数构建

  - [ ] 9.4 实现API响应解析
    - 实现parse_api_response()方法
    - 支持91HTTP格式（code=0, data.proxy_list）
    - 支持通用格式（success=true, data）
    - 实现_extract_value_by_path()辅助方法
    - _需求: 6.3_

  - [ ]* 9.5 编写API响应解析属性测试
    - **属性 17: API响应解析**
    - **验证需求: 6.3**

  - [ ] 9.6 实现API错误处理和重试
    - 实现_make_request()方法
    - 实现指数退避重试逻辑
    - 实现超时处理
    - _需求: 6.4, 6.5, 4.5_

  - [ ]* 9.7 编写API错误处理属性测试
    - **属性 18: API错误处理**
    - **验证需求: 6.4, 6.5**

  - [ ]* 9.8 编写API重试属性测试
    - **属性 14: API失败重试**
    - **验证需求: 4.5**

  - [ ] 9.9 实现API连接测试功能
    - 实现test_connection()方法
    - 验证API端点可达性
    - _需求: 6.1_

- [ ] 10. 实现健康监控器 (HealthMonitor)
  - [ ] 10.1 创建健康监控器基础类
    - 实现HealthMonitor类框架
    - 实现监控状态管理
    - _需求: 3.1_

  - [ ] 10.2 实现健康检查逻辑
    - 实现check_proxy_health()方法
    - 通过代理发送HTTP请求到检查URL
    - 记录响应时间
    - _需求: 3.4_

  - [ ]* 10.3 编写健康检查属性测试
    - **属性 9: 通过代理进行健康检查**
    - **验证需求: 3.4**

  - [ ] 10.4 实现监控循环
    - 实现_monitoring_loop()方法
    - 在独立线程中运行
    - 按配置间隔执行检查
    - _需求: 3.1, 3.2_

  - [ ]* 10.5 编写定期健康检查属性测试
    - **属性 7: 定期健康检查**
    - **验证需求: 3.1, 3.2**

  - [ ] 10.6 实现失败计数和状态标记
    - 跟踪连续失败次数
    - 更新监控状态到数据库
    - _需求: 3.3_

  - [ ]* 10.7 编写健康状态标记属性测试
    - **属性 8: 健康状态标记**
    - **验证需求: 3.3**

  - [ ] 10.8 实现失败阈值触发逻辑
    - 检查失败次数是否达到阈值
    - 触发代理切换
    - _需求: 3.5_

  - [ ]* 10.9 编写失败阈值属性测试
    - **属性 10: 失败阈值触发切换**
    - **验证需求: 3.5**

  - [ ] 10.10 实现监控启动和停止
    - 实现start_monitoring()方法
    - 实现stop_monitoring()方法
    - 持久化监控状态
    - _需求: 5.1, 5.2, 5.3, 5.4_

  - [ ]* 10.11 编写监控状态控制属性测试
    - **属性 15: 监控状态控制**
    - **验证需求: 3.1, 5.3**

- [ ] 11. 实现自动代理切换逻辑
  - [ ] 11.1 扩展ProxyManager支持切换
    - 实现switch_upstream_proxy()方法
    - 实现get_new_proxy_from_api()方法
    - 实现validate_upstream_proxy()方法
    - _需求: 4.1, 4.2, 4.3_

  - [ ]* 11.2 编写自动获取新代理属性测试
    - **属性 11: 自动获取新代理**
    - **验证需求: 4.1**

  - [ ]* 11.3 编写切换后配置更新属性测试
    - **属性 12: 切换后配置更新**
    - **验证需求: 4.2**

  - [ ] 11.4 实现切换事件日志记录
    - 记录切换历史到数据库
    - 记录详细的切换信息
    - _需求: 4.4, 8.1_

  - [ ]* 11.5 编写事件日志记录属性测试
    - **属性 13: 重要事件日志记录**
    - **验证需求: 4.4, 8.1, 8.2, 8.3**

- [ ] 12. 扩展CLI支持监控控制
  - [ ] 12.1 添加监控控制命令
    - 实现monitor start <port>命令
    - 实现monitor stop <port>命令
    - 实现monitor status命令
    - _需求: 5.1, 5.2, 5.5, 9.4_

  - [ ] 12.2 添加手动切换命令
    - 实现switch <port>命令
    - 手动触发代理切换
    - _需求: 9.5_

  - [ ]* 12.3 编写监控控制命令集成测试
    - 测试monitor start命令
    - 测试monitor stop命令
    - 测试switch命令

- [ ] 13. 第二阶段检查点
  - 确保所有测试通过
  - 手动测试自动监控和切换功能
  - 验证API集成工作正常
  - 如有问题请询问用户

### 阶段三: Web管理界面

- [ ] 14. 实现FastAPI后端
  - [ ] 14.1 创建FastAPI应用框架
    - 初始化FastAPI应用
    - 配置CORS
    - 设置路由结构
    - _需求: 10.1_

  - [ ] 14.2 实现代理管理API端点
    - GET /api/proxies - 获取所有代理
    - POST /api/proxies - 添加新代理
    - GET /api/proxies/{port} - 获取指定代理
    - PUT /api/proxies/{port} - 更新代理
    - DELETE /api/proxies/{port} - 删除代理
    - _需求: 10.2, 10.3_

  - [ ]* 14.3 编写代理管理API单元测试
    - 测试所有CRUD端点
    - 使用TestClient测试

  - [ ] 14.4 实现监控控制API端点
    - POST /api/proxies/{port}/monitoring/start
    - POST /api/proxies/{port}/monitoring/stop
    - GET /api/proxies/{port}/monitoring/status
    - _需求: 10.4_

  - [ ]* 14.5 编写监控控制API单元测试
    - 测试启动监控端点
    - 测试停止监控端点

  - [ ] 14.6 实现手动操作API端点
    - POST /api/proxies/{port}/switch - 手动切换
    - POST /api/proxies/{port}/test - 测试连接
    - _需求: 10.4_

  - [ ] 14.7 实现系统信息API端点
    - GET /api/system/status - 系统状态
    - GET /api/system/logs - 日志查询
    - GET /api/history - 切换历史
    - _需求: 10.5, 10.6_

  - [ ] 14.8 实现配置管理API端点
    - GET /api/config - 获取系统配置
    - PUT /api/config - 更新系统配置
    - _需求: 10.3_

  - [ ] 14.9 实现API提供商管理端点
    - GET /api/api-providers - 获取所有提供商
    - POST /api/api-providers - 添加提供商
    - GET /api/api-providers/{id} - 获取指定提供商
    - PUT /api/api-providers/{id} - 更新提供商
    - DELETE /api/api-providers/{id} - 删除提供商
    - POST /api/api-providers/{id}/test - 测试连接
    - _需求: 10.3_

  - [ ]* 14.10 编写API提供商管理单元测试
    - 测试所有提供商管理端点

- [ ] 15. 实现Web认证
  - [ ] 15.1 实现认证中间件
    - 实现HTTP Basic Auth或JWT
    - 使用bcrypt哈希密码
    - _需求: 10.7, 10.8_

  - [ ]* 15.2 编写Web认证属性测试
    - **属性 25: Web认证保护**
    - **验证需求: 10.7**

- [ ] 16. 实现Web前端界面
  - [ ] 16.1 创建HTML模板结构
    - 创建基础布局模板
    - 使用Tailwind CSS样式
    - 集成Alpine.js
    - _需求: 10.1_

  - [ ] 16.2 实现仪表板页面
    - 显示所有代理端口状态
    - 显示监控状态
    - 显示最近切换记录
    - _需求: 10.1, 10.9_

  - [ ]* 16.3 编写Web界面显示属性测试
    - **属性 22: Web界面显示完整性**
    - **验证需求: 10.1, 10.9**

  - [ ] 16.4 实现代理管理页面
    - 代理列表显示
    - 添加代理表单
    - 编辑代理表单
    - 删除代理确认
    - _需求: 10.2, 10.3_

  - [ ] 16.5 实现监控控制页面
    - 启动/停止监控按钮
    - 实时健康状态显示
    - 监控配置设置
    - _需求: 10.4, 10.5_

  - [ ] 16.6 实现历史记录页面
    - 切换历史列表
    - 时间过滤
    - 详细信息查看
    - _需求: 10.6_

  - [ ]* 16.7 编写Web界面历史记录属性测试
    - **属性 24: Web界面历史记录**
    - **验证需求: 10.6**

  - [ ] 16.8 实现系统设置页面
    - 监控参数配置
    - API设置配置
    - 日志级别设置
    - _需求: 10.3_

  - [ ] 16.9 实现API提供商管理页面
    - 提供商列表显示
    - 添加/编辑提供商表单
    - 测试连接按钮
    - _需求: 10.3_

  - [ ]* 16.10 编写Web界面操作属性测试
    - **属性 23: Web界面操作正确性**
    - **验证需求: 10.2, 10.3, 10.4**

- [ ] 17. 实现实时状态更新
  - 使用WebSocket或Server-Sent Events
  - 推送代理状态变化
  - 推送监控状态更新
  - _需求: 10.5_

- [ ] 18. 第三阶段检查点
  - 确保所有测试通过
  - 手动测试Web界面所有功能
  - 测试不同浏览器兼容性
  - 如有问题请询问用户

### 阶段四: 系统集成和部署

- [ ] 19. 实现systemd服务集成
  - [ ] 19.1 创建systemd服务单元文件
    - 编写proxy-relay.service文件
    - 配置服务依赖和启动顺序
    - 配置安全加固选项
    - _需求: 11.1, 11.5_

  - [ ] 19.2 实现优雅关闭
    - 处理SIGTERM和SIGINT信号
    - 关闭所有连接
    - 保存状态
    - _需求: 11.3_

  - [ ]* 19.3 编写优雅关闭属性测试
    - **属性 26: 优雅关闭**
    - **验证需求: 11.3**

  - [ ] 19.4 实现服务安装脚本
    - 创建安装脚本
    - 创建proxy-relay用户和组
    - 设置文件权限
    - 注册systemd服务
    - _需求: 11.5_

- [ ] 20. 实现部署和安装
  - [ ] 20.1 创建安装脚本
    - 检查系统要求
    - 安装依赖（Python, sing-box）
    - 创建目录结构
    - 复制文件到目标位置
    - _需求: 所有需求_

  - [ ] 20.2 创建配置向导
    - 交互式配置生成
    - 验证配置有效性
    - 生成初始配置文件
    - _需求: 7.1, 7.2_

  - [ ] 20.3 编写部署文档
    - 详细的安装步骤
    - 配置说明
    - 故障排查指南
    - _需求: 所有需求_

- [ ] 21. 实现额外的属性测试
  - [ ]* 21.1 编写多端口代理绑定属性测试
    - **属性 1: 多端口代理绑定**
    - **验证需求: 1.1, 1.3**

  - [ ]* 21.2 编写流量正确转发属性测试
    - **属性 2: 流量正确转发**
    - **验证需求: 1.2**

  - [ ]* 21.3 编写热切换保持连接属性测试
    - **属性 3: 热切换保持连接**
    - **验证需求: 1.4**

  - [ ]* 21.4 编写认证支持属性测试
    - **属性 6: 认证支持**
    - **验证需求: 2.5**

  - [ ]* 21.5 编写API端点配置属性测试
    - **属性 16: API端点配置**
    - **验证需求: 6.1, 6.2**

- [ ] 22. 集成测试和端到端测试
  - [ ]* 22.1 编写端到端代理流量测试
    - 启动完整系统
    - 通过代理发送请求
    - 验证流量正确转发

  - [ ]* 22.2 编写自动切换流程集成测试
    - 模拟上游代理失败
    - 验证自动切换触发
    - 验证新代理生效

  - [ ]* 22.3 编写Web界面集成测试
    - 使用Selenium或Playwright
    - 测试完整的用户操作流程

- [ ] 23. 性能测试和优化
  - [ ]* 23.1 编写负载测试
    - 测试并发连接处理
    - 测试多端口性能
    - 测试长时间运行稳定性

  - [ ]* 23.2 性能分析和优化
    - 使用profiler分析性能瓶颈
    - 优化关键路径
    - 减少内存使用

- [ ] 24. 最终检查点
  - 确保所有测试通过
  - 完成所有文档
  - 进行完整的系统测试
  - 准备发布

## 注意事项

- 标记为 `*` 的任务是可选的测试任务，可以跳过以加快MVP开发
- 每个属性测试必须运行至少100次迭代
- 每个属性测试必须包含注释标签：**Feature: proxy-relay-system, Property {number}: {property_text}**
- 在每个阶段检查点，确保所有测试通过后再继续下一阶段
- 优先实现核心功能，测试可以在功能稳定后补充
