# Proxy Relay v1.2.0 Hotfix

## 问题描述

v1.2.0 版本在启动时出现两个错误：

1. `NameError: name 'e' is not defined` - 异常变量作用域问题
2. `'WebAPI' object has no attribute 'page_upstream_proxies'` - 文件末尾有孤立的方法定义

**错误位置**: `src/proxy_relay/web_api.py` 第 2514 行及文件末尾

**原因**: 
- 异常变量 `e` 在嵌套函数 `root()` 中引用时超出作用域
- 文件末尾有 400+ 行孤立的方法定义（不属于任何类）

## 修复内容

1. 将异常消息保存到变量 `error_message` 中，使其在嵌套函数中可访问
2. 删除文件末尾所有孤立的方法定义（这些方法已在 WebAPI 类中正确定义）

## 安装步骤

### 方法一：完整解压（推荐）

```bash
# 停止服务
sudo systemctl stop proxy-relay

# 备份当前版本
sudo cp -r /opt/proxy-relay/app /opt/proxy-relay/app.backup.$(date +%Y%m%d_%H%M%S)

# 上传并解压新版本
cd /tmp
tar -xzf proxy-relay-v1.2.0-final.tar.gz

# 覆盖源代码
sudo cp -r src/* /opt/proxy-relay/app/src/

# 重启服务
sudo systemctl start proxy-relay
sudo systemctl status proxy-relay
```

### 方法二：只替换 web_api.py

```bash
# 停止服务
sudo systemctl stop proxy-relay

# 备份原文件
sudo cp /opt/proxy-relay/app/src/proxy_relay/web_api.py /opt/proxy-relay/app/src/proxy_relay/web_api.py.backup

# 上传并替换文件
cd /tmp
tar -xzf proxy-relay-v1.2.0-final.tar.gz
sudo cp src/proxy_relay/web_api.py /opt/proxy-relay/app/src/proxy_relay/

# 重启服务
sudo systemctl start proxy-relay
sudo systemctl status proxy-relay
```

## 验证修复

访问 Web 界面，确认服务正常运行：

```bash
# 检查服务状态
sudo systemctl status proxy-relay

# 测试 API
curl http://localhost:8080/

# 应该返回正常的 JSON 响应，包含 version, status 等字段
# 而不是 error 信息
```

## 包信息

- **文件名**: `proxy-relay-v1.2.0-final.tar.gz`
- **大小**: 218 KB
- **MD5**: `c24c07ce958fff83b2ba7edead342845`
- **修复时间**: 2026-01-12 14:16

## 快速修复命令

```bash
# 一键修复（完整解压）
sudo systemctl stop proxy-relay && \
cd /tmp && \
tar -xzf proxy-relay-v1.2.0-final.tar.gz && \
sudo cp -r src/* /opt/proxy-relay/app/src/ && \
sudo systemctl start proxy-relay && \
sudo systemctl status proxy-relay
```

## 注意事项

- 此修复只更新了源代码，不影响配置文件和数据库
- 无需重新安装依赖或修改配置
- 如果遇到问题，可以从备份恢复：
  ```bash
  sudo systemctl stop proxy-relay
  sudo rm -rf /opt/proxy-relay/app
  sudo mv /opt/proxy-relay/app.backup.XXXXXX /opt/proxy-relay/app
  sudo systemctl start proxy-relay
  ```

## 技术细节

**修复前的问题代码**:
```python
except Exception as e:
    logger.error(f"创建默认应用实例失败: {e}")
    app = FastAPI(...)
    
    @app.get("/")
    async def root():
        return {"error": "应用初始化失败", "message": str(e)}  # ❌ e 超出作用域
```

**修复后的代码**:
```python
except Exception as e:
    error_message = str(e)  # ✅ 保存到变量
    logger.error(f"创建默认应用实例失败: {error_message}")
    app = FastAPI(...)
    
    @app.get("/")
    async def root():
        return {"error": "应用初始化失败", "message": error_message}  # ✅ 使用变量
```
