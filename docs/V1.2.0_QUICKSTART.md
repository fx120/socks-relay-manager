# v1.2.0 快速开始指南

## 什么是出口代理池？

出口代理池是 v1.2.0 引入的新功能，它将出口代理的管理与本地代理配置分离：

- **旧方式 (v1.1.0)**: 每个本地代理直接配置自己的出口代理
- **新方式 (v1.2.0)**: 先在出口代理池中添加代理，然后本地代理通过 ID 引用

## 为什么使用出口代理池？

### 优势

1. **复用性**: 一个出口代理可被多个本地代理使用
2. **易管理**: 集中管理所有出口代理，修改一处即可
3. **易切换**: 本地代理可以轻松切换使用的出口代理
4. **清晰性**: 清楚地看到哪些本地代理在使用哪个出口代理

### 使用场景

- 多个本地代理使用同一个出口代理
- 需要频繁切换出口代理
- 需要统一管理大量出口代理
- 需要测试和比较不同出口代理

## 快速开始

### 方式 1: 通过 API（推荐）

#### 步骤 1: 创建出口代理

```bash
curl -X POST http://localhost:8080/api/upstream-proxies \
  -H "Content-Type: application/json" \
  -u admin:your_password \
  -d '{
    "id": "us-node-1",
    "name": "美国节点1",
    "enabled": true,
    "description": "高速美国节点",
    "tags": ["美国", "高速"],
    "proxy": {
      "server": "us.example.com",
      "port": 443,
      "protocol": "vless",
      "uuid": "550e8400-e29b-41d4-a716-446655440000",
      "network": "ws",
      "tls": true,
      "sni": "us.example.com",
      "ws_path": "/ws"
    }
  }'
```

#### 步骤 2: 创建本地代理并引用出口代理

```bash
curl -X POST http://localhost:8080/api/proxies \
  -H "Content-Type: application/json" \
  -u admin:your_password \
  -d '{
    "local_port": 1080,
    "name": "本地代理1",
    "upstream_id": "us-node-1",
    "monitoring_enabled": true
  }'
```

#### 步骤 3: 测试出口代理

```bash
curl -X POST http://localhost:8080/api/upstream-proxies/us-node-1/test \
  -u admin:your_password
```

#### 步骤 4: 查看所有出口代理

```bash
curl http://localhost:8080/api/upstream-proxies \
  -u admin:your_password
```

### 方式 2: 通过配置文件

#### 步骤 1: 编辑配置文件

编辑 `/etc/proxy-relay/config.yaml`:

```yaml
# 出口代理池（新增）
upstream_proxies:
  - id: us-node-1
    name: "美国节点1"
    enabled: true
    description: "高速美国节点"
    tags: ["美国", "高速"]
    proxy:
      server: us.example.com
      port: 443
      protocol: vless
      uuid: "550e8400-e29b-41d4-a716-446655440000"
      network: ws
      tls: true
      sni: us.example.com
      ws_path: /ws
  
  - id: jp-node-1
    name: "日本节点1"
    enabled: true
    proxy:
      server: jp.example.com
      port: 443
      protocol: vless
      uuid: "660e8400-e29b-41d4-a716-446655440001"
      network: ws
      tls: true
      sni: jp.example.com

# 本地代理
proxies:
  - local_port: 1080
    name: "代理1"
    upstream_id: us-node-1  # 引用出口代理池
    monitoring_enabled: true
  
  - local_port: 1081
    name: "代理2"
    upstream_id: jp-node-1  # 引用另一个出口代理
    monitoring_enabled: true
```

#### 步骤 2: 重启服务

```bash
sudo systemctl restart proxy-relay
```

## 常见操作

### 1. 切换本地代理使用的出口代理

```bash
curl -X PUT http://localhost:8080/api/proxies/1080 \
  -H "Content-Type: application/json" \
  -u admin:your_password \
  -d '{
    "upstream_id": "jp-node-1"
  }'
```

### 2. 更新出口代理配置

```bash
curl -X PUT http://localhost:8080/api/upstream-proxies/us-node-1 \
  -H "Content-Type: application/json" \
  -u admin:your_password \
  -d '{
    "name": "美国节点1（更新）",
    "description": "超高速美国节点"
  }'
```

### 3. 查看出口代理使用情况

```bash
curl http://localhost:8080/api/upstream-proxies/us-node-1 \
  -u admin:your_password
```

响应示例：
```json
{
  "id": "us-node-1",
  "name": "美国节点1",
  "enabled": true,
  "usage_count": 2,
  "used_by_ports": [1080, 1082]
}
```

### 4. 删除出口代理

注意：只能删除未被使用的出口代理。

```bash
curl -X DELETE http://localhost:8080/api/upstream-proxies/us-node-1 \
  -u admin:your_password
```

如果出口代理正在被使用，会返回错误：
```json
{
  "detail": "Cannot delete upstream proxy 'us-node-1' because it is being used by 2 local proxy(ies)"
}
```

### 5. 添加 SOCKS5 出口代理

```bash
curl -X POST http://localhost:8080/api/upstream-proxies \
  -H "Content-Type: application/json" \
  -u admin:your_password \
  -d '{
    "id": "socks5-node-1",
    "name": "SOCKS5代理1",
    "enabled": true,
    "proxy": {
      "server": "proxy.example.com",
      "port": 1080,
      "protocol": "socks5",
      "username": "user",
      "password": "pass"
    }
  }'
```

## 配置示例

### 示例 1: 多个本地代理使用同一个出口代理

```yaml
upstream_proxies:
  - id: shared-proxy
    name: "共享代理"
    proxy:
      server: shared.example.com
      port: 443
      protocol: vless
      uuid: "..."

proxies:
  - local_port: 1080
    name: "代理1"
    upstream_id: shared-proxy
  
  - local_port: 1081
    name: "代理2"
    upstream_id: shared-proxy
  
  - local_port: 1082
    name: "代理3"
    upstream_id: shared-proxy
```

### 示例 2: 混合使用新旧方式

```yaml
upstream_proxies:
  - id: pool-proxy-1
    name: "池中代理1"
    proxy:
      server: pool.example.com
      port: 443
      protocol: vless
      uuid: "..."

proxies:
  # 使用出口代理池（新方式）
  - local_port: 1080
    name: "代理1"
    upstream_id: pool-proxy-1
  
  # 直接配置（旧方式，向后兼容）
  - local_port: 1081
    name: "代理2"
    upstream:
      server: direct.example.com
      port: 443
      protocol: vless
      uuid: "..."
  
  # 直连模式
  - local_port: 1082
    name: "直连代理"
```

### 示例 3: 使用标签分类

```yaml
upstream_proxies:
  - id: us-fast-1
    name: "美国高速1"
    tags: ["美国", "高速", "稳定"]
    proxy:
      server: us-fast.example.com
      port: 443
      protocol: vless
      uuid: "..."
  
  - id: us-cheap-1
    name: "美国经济1"
    tags: ["美国", "经济", "备用"]
    proxy:
      server: us-cheap.example.com
      port: 443
      protocol: vless
      uuid: "..."
  
  - id: jp-fast-1
    name: "日本高速1"
    tags: ["日本", "高速", "游戏"]
    proxy:
      server: jp-fast.example.com
      port: 443
      protocol: vless
      uuid: "..."
```

## 从 v1.1.0 迁移

### 自动迁移（推荐）

v1.2.0 完全兼容 v1.1.0 的配置格式，无需手动迁移。

### 手动迁移（可选）

如果想使用新的出口代理池功能：

#### 迁移前 (v1.1.0)
```yaml
proxies:
  - local_port: 1080
    name: "代理1"
    upstream:
      server: us.example.com
      port: 443
      protocol: vless
      uuid: "..."
```

#### 迁移后 (v1.2.0)
```yaml
upstream_proxies:
  - id: us-node-1
    name: "美国节点1"
    proxy:
      server: us.example.com
      port: 443
      protocol: vless
      uuid: "..."

proxies:
  - local_port: 1080
    name: "代理1"
    upstream_id: us-node-1
```

## 故障排除

### 问题 1: 引用的出口代理不存在

**错误信息**:
```
Upstream proxy 'xxx' not found in upstream proxy pool
```

**解决方法**:
1. 检查 `upstream_id` 是否正确
2. 确认出口代理池中存在该 ID
3. 使用 API 查看所有出口代理：`GET /api/upstream-proxies`

### 问题 2: 无法删除出口代理

**错误信息**:
```
Cannot delete upstream proxy 'xxx' because it is being used by N local proxy(ies)
```

**解决方法**:
1. 先修改使用该出口代理的本地代理
2. 将它们切换到其他出口代理或直连模式
3. 然后再删除出口代理

### 问题 3: 配置文件格式错误

**错误信息**:
```
Configuration validation failed
```

**解决方法**:
1. 检查 YAML 格式是否正确
2. 确认所有必需字段都已填写
3. 验证 `upstream_id` 引用的有效性
4. 查看日志获取详细错误信息

## 最佳实践

### 1. 命名规范

- **ID**: 使用有意义的标识符，如 `us-node-1`, `jp-fast-1`
- **名称**: 使用描述性名称，如 "美国节点1", "日本高速节点"
- **标签**: 使用一致的标签体系，如地区、速度、用途

### 2. 组织结构

```yaml
upstream_proxies:
  # 按地区分组
  # 美国节点
  - id: us-node-1
    name: "美国节点1"
    tags: ["美国", "高速"]
    ...
  
  - id: us-node-2
    name: "美国节点2"
    tags: ["美国", "备用"]
    ...
  
  # 日本节点
  - id: jp-node-1
    name: "日本节点1"
    tags: ["日本", "高速"]
    ...
```

### 3. 测试流程

1. 添加出口代理后立即测试
2. 定期测试出口代理的可用性
3. 监控使用统计，及时发现问题

### 4. 备份策略

- 定期备份配置文件
- 记录重要的出口代理信息
- 保留多个备用出口代理

## 下一步

- 查看完整文档：`docs/UPSTREAM_POOL_ARCHITECTURE.md`
- 查看 API 文档：`docs/API.md`（待创建）
- 查看发布说明：`docs/V1.2.0_RELEASE_NOTES.md`

## 获取帮助

如有问题，请：
1. 查看故障排除文档：`docs/TROUBLESHOOTING.md`
2. 查看日志：`/var/log/proxy-relay/app.log`
3. 提交 Issue
