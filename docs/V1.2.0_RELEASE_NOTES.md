# Proxy Relay System v1.2.0 å‘å¸ƒè¯´æ˜

## ç‰ˆæœ¬ä¿¡æ¯

- **ç‰ˆæœ¬å·**: v1.2.0
- **å‘å¸ƒæ—¥æœŸ**: 2026-01-12
- **ç±»å‹**: åŠŸèƒ½æ›´æ–°ï¼ˆFeature Releaseï¼‰

## æ¦‚è¿°

v1.2.0 å¼•å…¥äº†**å‡ºå£ä»£ç†æ± ï¼ˆUpstream Proxy Poolï¼‰**æ¶æ„ï¼Œå°†å‡ºå£ä»£ç†ç®¡ç†ä¸æœ¬åœ°ä»£ç†é…ç½®è§£è€¦ï¼Œæä¾›æ›´çµæ´»å’Œå¯ç»´æŠ¤çš„ä»£ç†ç®¡ç†æ–¹å¼ã€‚

## ä¸»è¦æ–°ç‰¹æ€§

### 1. å‡ºå£ä»£ç†æ± ç®¡ç† ğŸ¯

ç‹¬ç«‹ç®¡ç†æ‰€æœ‰å‡ºå£ä»£ç†æœåŠ¡å™¨çš„é…ç½®åº“ï¼š

- **é›†ä¸­ç®¡ç†**: æ‰€æœ‰å‡ºå£ä»£ç†åœ¨ä¸€ä¸ªåœ°æ–¹ç»Ÿä¸€ç®¡ç†
- **å”¯ä¸€æ ‡è¯†**: æ¯ä¸ªå‡ºå£ä»£ç†æœ‰å”¯ä¸€ IDï¼Œä¾¿äºå¼•ç”¨
- **å¤ç”¨æ€§**: ä¸€ä¸ªå‡ºå£ä»£ç†å¯è¢«å¤šä¸ªæœ¬åœ°ä»£ç†ä½¿ç”¨
- **çµæ´»åˆ‡æ¢**: æœ¬åœ°ä»£ç†å¯éšæ—¶åˆ‡æ¢ä½¿ç”¨çš„å‡ºå£ä»£ç†
- **æ ‡ç­¾åˆ†ç±»**: æ”¯æŒä¸ºå‡ºå£ä»£ç†æ·»åŠ æ ‡ç­¾ï¼ˆå¦‚åœ°åŒºã€é€Ÿåº¦ç­‰ï¼‰

### 2. æ–°çš„é…ç½®æ ¼å¼

#### å‡ºå£ä»£ç†æ± é…ç½®

```yaml
upstream_proxies:
  - id: upstream-001
    name: "ç¾å›½èŠ‚ç‚¹1"
    enabled: true
    description: "é«˜é€Ÿç¾å›½èŠ‚ç‚¹"
    tags: ["ç¾å›½", "é«˜é€Ÿ", "ç¨³å®š"]
    proxy:
      server: us.example.com
      port: 443
      protocol: vless
      uuid: "550e8400-e29b-41d4-a716-446655440000"
      network: ws
      tls: true
      sni: us.example.com
```

#### æœ¬åœ°ä»£ç†å¼•ç”¨

```yaml
proxies:
  - local_port: 1080
    name: "ä»£ç†1"
    upstream_id: upstream-001  # å¼•ç”¨å‡ºå£ä»£ç†æ± 
    monitoring_enabled: true
```

### 3. Web ç•Œé¢æ›´æ–°

#### æ–°å¢é¡µé¢
- **å‡ºå£ä»£ç†æ± ç®¡ç†é¡µé¢** (`/upstream-proxies`)
  - æŸ¥çœ‹æ‰€æœ‰å‡ºå£ä»£ç†
  - æ·»åŠ /ç¼–è¾‘/åˆ é™¤å‡ºå£ä»£ç†
  - æµ‹è¯•å‡ºå£ä»£ç†è¿æ¥
  - æŸ¥çœ‹ä½¿ç”¨ç»Ÿè®¡

#### æ›´æ–°é¡µé¢
- **æœ¬åœ°ä»£ç†ç®¡ç†é¡µé¢** (`/proxies`)
  - æ”¯æŒä»å‡ºå£ä»£ç†æ± é€‰æ‹©
  - æ˜¾ç¤ºå¼•ç”¨çš„å‡ºå£ä»£ç†ä¿¡æ¯
  - ä¿æŒå‘åå…¼å®¹ï¼ˆä»æ”¯æŒç›´æ¥é…ç½®ï¼‰

### 4. API ç«¯ç‚¹

#### å‡ºå£ä»£ç†æ±  API

```
GET    /api/upstream-proxies           # è·å–æ‰€æœ‰å‡ºå£ä»£ç†
POST   /api/upstream-proxies           # æ·»åŠ å‡ºå£ä»£ç†
GET    /api/upstream-proxies/{id}      # è·å–å•ä¸ªå‡ºå£ä»£ç†
PUT    /api/upstream-proxies/{id}      # æ›´æ–°å‡ºå£ä»£ç†
DELETE /api/upstream-proxies/{id}      # åˆ é™¤å‡ºå£ä»£ç†
POST   /api/upstream-proxies/{id}/test # æµ‹è¯•å‡ºå£ä»£ç†
```

#### æœ¬åœ°ä»£ç† API æ›´æ–°

```
POST   /api/proxies
  Body: {
    "local_port": 1080,
    "name": "ä»£ç†1",
    "upstream_id": "upstream-001",  # æ–°å¢ï¼šå¼•ç”¨å‡ºå£ä»£ç†
    "monitoring_enabled": true
  }

PUT    /api/proxies/{port}
  Body: {
    "upstream_id": "upstream-002"   # æ–°å¢ï¼šåˆ‡æ¢å‡ºå£ä»£ç†
  }
```

## æŠ€æœ¯æ”¹è¿›

### 1. æ•°æ®æ¨¡å‹æ‰©å±•

- æ–°å¢ `UpstreamProxyPool` æ•°æ®ç±»
- `ProxyConfig` æ–°å¢ `upstream_id` å­—æ®µ
- `Config` æ–°å¢ `upstream_proxies` åˆ—è¡¨

### 2. é…ç½®ç®¡ç†å™¨æ›´æ–°

- æ”¯æŒè§£æ `upstream_proxies` é…ç½®æ®µ
- æ”¯æŒåºåˆ—åŒ–å‡ºå£ä»£ç†æ± åˆ°é…ç½®æ–‡ä»¶
- éªŒè¯ `upstream_id` å¼•ç”¨çš„æœ‰æ•ˆæ€§

### 3. ä»£ç†ç®¡ç†å™¨æ›´æ–°

- æ”¯æŒæ ¹æ® `upstream_id` è§£æå‡ºå£ä»£ç†
- ä¼˜å…ˆä½¿ç”¨ `upstream_id`ï¼Œå…¶æ¬¡ä½¿ç”¨ç›´æ¥é…ç½®çš„ `upstream`
- ç”Ÿæˆ sing-box é…ç½®æ—¶è‡ªåŠ¨è§£æå¼•ç”¨

### 4. æ•°æ®åº“æ‰©å±•

- æ–°å¢ `upstream_proxies` è¡¨
- æ–°å¢ `upstream_usage` è¡¨ï¼ˆè®°å½•ä½¿ç”¨æƒ…å†µï¼‰
- æ”¯æŒæŸ¥è¯¢å‡ºå£ä»£ç†ä½¿ç”¨ç»Ÿè®¡

## å‘åå…¼å®¹æ€§

### âœ… å®Œå…¨å…¼å®¹ v1.1.0

- **é…ç½®æ–‡ä»¶**: æ—§æ ¼å¼é…ç½®æ–‡ä»¶æ— éœ€ä¿®æ”¹å³å¯ä½¿ç”¨
- **API**: æ‰€æœ‰ v1.1.0 API ç«¯ç‚¹ä¿æŒå…¼å®¹
- **åŠŸèƒ½**: ç›´æ¥é…ç½® `upstream` çš„æ–¹å¼ä»ç„¶æ”¯æŒ

### é…ç½®æ ¼å¼å¯¹æ¯”

#### v1.1.0 æ ¼å¼ï¼ˆä»ç„¶æ”¯æŒï¼‰
```yaml
proxies:
  - local_port: 1080
    name: "ä»£ç†1"
    upstream:  # ç›´æ¥é…ç½®
      server: us.example.com
      port: 443
      protocol: vless
      uuid: "..."
    monitoring_enabled: true
```

#### v1.2.0 æ–°æ ¼å¼ï¼ˆæ¨èï¼‰
```yaml
upstream_proxies:
  - id: upstream-001
    name: "ç¾å›½èŠ‚ç‚¹1"
    proxy:
      server: us.example.com
      port: 443
      protocol: vless
      uuid: "..."

proxies:
  - local_port: 1080
    name: "ä»£ç†1"
    upstream_id: upstream-001  # å¼•ç”¨
    monitoring_enabled: true
```

## å‡çº§æŒ‡å—

### ä» v1.1.0 å‡çº§åˆ° v1.2.0

1. **å¤‡ä»½é…ç½®æ–‡ä»¶**
   ```bash
   cp /etc/proxy-relay/config.yaml /etc/proxy-relay/config.yaml.backup
   ```

2. **åœæ­¢æœåŠ¡**
   ```bash
   sudo systemctl stop proxy-relay
   sudo systemctl stop sing-box
   ```

3. **æ›´æ–°ä»£ç **
   ```bash
   # è§£å‹æ›´æ–°åŒ…
   tar -xzf proxy-relay-v1.2.0.tar.gz
   cd proxy-relay
   
   # å®‰è£…ä¾èµ–
   pip install -r requirements.txt
   ```

4. **å¯åŠ¨æœåŠ¡**
   ```bash
   sudo systemctl start sing-box
   sudo systemctl start proxy-relay
   ```

5. **éªŒè¯å‡çº§**
   ```bash
   # æ£€æŸ¥æœåŠ¡çŠ¶æ€
   sudo systemctl status proxy-relay
   
   # è®¿é—® Web ç•Œé¢
   # åº”è¯¥èƒ½çœ‹åˆ°æ–°çš„"å‡ºå£ä»£ç†æ± "èœå•é¡¹
   ```

### å¯é€‰ï¼šè¿ç§»åˆ°æ–°æ ¼å¼

è™½ç„¶ä¸æ˜¯å¿…éœ€çš„ï¼Œä½†æ¨èè¿ç§»åˆ°æ–°çš„é…ç½®æ ¼å¼ä»¥äº«å—å‡ºå£ä»£ç†æ± çš„ä¼˜åŠ¿ï¼š

1. **è®¿é—® Web ç•Œé¢** â†’ å‡ºå£ä»£ç†æ± 
2. **æ·»åŠ å‡ºå£ä»£ç†** â†’ ä»ç°æœ‰é…ç½®ä¸­å¤åˆ¶ä»£ç†ä¿¡æ¯
3. **ç¼–è¾‘æœ¬åœ°ä»£ç†** â†’ é€‰æ‹©ä½¿ç”¨å‡ºå£ä»£ç†æ± ä¸­çš„ä»£ç†
4. **ä¿å­˜é…ç½®** â†’ ç³»ç»Ÿä¼šè‡ªåŠ¨æ›´æ–°é…ç½®æ–‡ä»¶

## ä½¿ç”¨ç¤ºä¾‹

### ç¤ºä¾‹ 1: åˆ›å»ºå‡ºå£ä»£ç†æ± 

```bash
# é€šè¿‡ API åˆ›å»ºå‡ºå£ä»£ç†
curl -X POST http://localhost:8080/api/upstream-proxies \
  -H "Content-Type: application/json" \
  -d '{
    "id": "upstream-us-001",
    "name": "ç¾å›½èŠ‚ç‚¹1",
    "enabled": true,
    "description": "é«˜é€Ÿç¾å›½èŠ‚ç‚¹",
    "tags": ["ç¾å›½", "é«˜é€Ÿ"],
    "proxy": {
      "server": "us.example.com",
      "port": 443,
      "protocol": "vless",
      "uuid": "550e8400-e29b-41d4-a716-446655440000",
      "network": "ws",
      "tls": true,
      "sni": "us.example.com",
      "ws_path": "/ws"
    }
  }'
```

### ç¤ºä¾‹ 2: åˆ›å»ºå¼•ç”¨å‡ºå£ä»£ç†æ± çš„æœ¬åœ°ä»£ç†

```bash
# åˆ›å»ºæœ¬åœ°ä»£ç†ï¼Œå¼•ç”¨å‡ºå£ä»£ç†æ± 
curl -X POST http://localhost:8080/api/proxies \
  -H "Content-Type: application/json" \
  -d '{
    "local_port": 1080,
    "name": "æœ¬åœ°ä»£ç†1",
    "upstream_id": "upstream-us-001",
    "monitoring_enabled": true
  }'
```

### ç¤ºä¾‹ 3: åˆ‡æ¢æœ¬åœ°ä»£ç†ä½¿ç”¨çš„å‡ºå£ä»£ç†

```bash
# åˆ‡æ¢åˆ°å¦ä¸€ä¸ªå‡ºå£ä»£ç†
curl -X PUT http://localhost:8080/api/proxies/1080 \
  -H "Content-Type: application/json" \
  -d '{
    "upstream_id": "upstream-jp-001"
  }'
```

### ç¤ºä¾‹ 4: æµ‹è¯•å‡ºå£ä»£ç†

```bash
# æµ‹è¯•å‡ºå£ä»£ç†è¿æ¥
curl -X POST http://localhost:8080/api/upstream-proxies/upstream-us-001/test
```

## æ¶æ„ä¼˜åŠ¿

### 1. è§£è€¦ç®¡ç†
- å‡ºå£ä»£ç†å’Œæœ¬åœ°ä»£ç†åˆ†ç¦»
- ä¿®æ”¹å‡ºå£ä»£ç†ä¸å½±å“æœ¬åœ°ä»£ç†é…ç½®
- ä¾¿äºæ‰¹é‡ç®¡ç†å’Œç»´æŠ¤

### 2. å¤ç”¨æ€§
- ä¸€ä¸ªå‡ºå£ä»£ç†å¯è¢«å¤šä¸ªæœ¬åœ°ä»£ç†ä½¿ç”¨
- å‡å°‘é‡å¤é…ç½®
- ç»Ÿä¸€ç®¡ç†ç›¸åŒçš„å‡ºå£ä»£ç†

### 3. çµæ´»æ€§
- æœ¬åœ°ä»£ç†å¯éšæ—¶åˆ‡æ¢å‡ºå£ä»£ç†
- æ”¯æŒåŠ¨æ€è°ƒæ•´
- ä¾¿äºæµ‹è¯•å’Œæ¯”è¾ƒä¸åŒå‡ºå£ä»£ç†

### 4. å¯ç»´æŠ¤æ€§
- é›†ä¸­ç®¡ç†æ‰€æœ‰å‡ºå£ä»£ç†
- ç»Ÿä¸€æµ‹è¯•å’ŒéªŒè¯
- æ¸…æ™°çš„ä½¿ç”¨å…³ç³»

## å·²çŸ¥é—®é¢˜

æ— é‡å¤§å·²çŸ¥é—®é¢˜ã€‚

## æœªæ¥è®¡åˆ’

v1.3.0 å¯èƒ½åŒ…å«çš„åŠŸèƒ½ï¼š

- å‡ºå£ä»£ç†æ± è´Ÿè½½å‡è¡¡
- è‡ªåŠ¨æ•…éšœè½¬ç§»
- å‡ºå£ä»£ç†å¥åº·è¯„åˆ†
- æ‰¹é‡å¯¼å…¥å‡ºå£ä»£ç†
- å‡ºå£ä»£ç†åˆ†ç»„ç®¡ç†

## è´¡çŒ®è€…

æ„Ÿè°¢æ‰€æœ‰ä¸ºæ­¤ç‰ˆæœ¬åšå‡ºè´¡çŒ®çš„å¼€å‘è€…ã€‚

## æ”¯æŒ

å¦‚æœ‰é—®é¢˜æˆ–å»ºè®®ï¼Œè¯·ï¼š

1. æŸ¥çœ‹æ–‡æ¡£ï¼š`docs/UPSTREAM_POOL_ARCHITECTURE.md`
2. æŸ¥çœ‹æ•…éšœæ’é™¤ï¼š`docs/TROUBLESHOOTING.md`
3. æäº¤ Issue

## è®¸å¯è¯

æœ¬é¡¹ç›®é‡‡ç”¨ MIT è®¸å¯è¯ã€‚
