{% extends "base.html" %}

{% block title %}仪表板 - 代理中转系统{% endblock %}

{% block content %}
<div x-data="dashboardData()" x-init="init()">
    <!-- Page Header -->
    <div class="mb-6">
        <h2 class="text-3xl font-bold text-gray-800">仪表板</h2>
        <p class="text-gray-600 mt-1">系统概览和实时状态</p>
    </div>
    
    <!-- Stats Cards Row 1 -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
        <!-- Total Proxies -->
        <div class="bg-white rounded-lg shadow p-6">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-gray-500 text-sm">代理总数</p>
                    <p class="text-3xl font-bold text-gray-800 mt-2" x-text="systemStatus.total_proxies || 0"></p>
                </div>
                <div class="bg-blue-100 rounded-full p-3">
                    <i class="fas fa-server text-blue-600 text-2xl"></i>
                </div>
            </div>
        </div>
        
        <!-- Active Monitoring -->
        <div class="bg-white rounded-lg shadow p-6">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-gray-500 text-sm">监控中</p>
                    <p class="text-3xl font-bold text-gray-800 mt-2" x-text="systemStatus.active_monitoring || 0"></p>
                </div>
                <div class="bg-green-100 rounded-full p-3">
                    <i class="fas fa-heartbeat text-green-600 text-2xl"></i>
                </div>
            </div>
        </div>
        
        <!-- Healthy Proxies -->
        <div class="bg-white rounded-lg shadow p-6">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-gray-500 text-sm">健康代理</p>
                    <p class="text-3xl font-bold text-green-600 mt-2" x-text="systemStatus.healthy_proxies || 0"></p>
                </div>
                <div class="bg-green-100 rounded-full p-3">
                    <i class="fas fa-check-circle text-green-600 text-2xl"></i>
                </div>
            </div>
        </div>
        
        <!-- Unhealthy Proxies -->
        <div class="bg-white rounded-lg shadow p-6">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-gray-500 text-sm">异常代理</p>
                    <p class="text-3xl font-bold text-red-600 mt-2" x-text="systemStatus.unhealthy_proxies || 0"></p>
                </div>
                <div class="bg-red-100 rounded-full p-3">
                    <i class="fas fa-exclamation-circle text-red-600 text-2xl"></i>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Stats Cards Row 2 - Network Stats -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
        <!-- Total Connections -->
        <div class="bg-white rounded-lg shadow p-6">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-gray-500 text-sm">当前连接数</p>
                    <p class="text-3xl font-bold text-purple-600 mt-2" x-text="metrics.connections?.total || 0"></p>
                </div>
                <div class="bg-purple-100 rounded-full p-3">
                    <i class="fas fa-link text-purple-600 text-2xl"></i>
                </div>
            </div>
        </div>
        
        <!-- Upload Speed -->
        <div class="bg-white rounded-lg shadow p-6">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-gray-500 text-sm">上传速度</p>
                    <p class="text-2xl font-bold text-orange-600 mt-2" x-text="metrics.network?.send_speed_formatted || '0 B/s'"></p>
                </div>
                <div class="bg-orange-100 rounded-full p-3">
                    <i class="fas fa-arrow-up text-orange-600 text-2xl"></i>
                </div>
            </div>
        </div>
        
        <!-- Download Speed -->
        <div class="bg-white rounded-lg shadow p-6">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-gray-500 text-sm">下载速度</p>
                    <p class="text-2xl font-bold text-cyan-600 mt-2" x-text="metrics.network?.recv_speed_formatted || '0 B/s'"></p>
                </div>
                <div class="bg-cyan-100 rounded-full p-3">
                    <i class="fas fa-arrow-down text-cyan-600 text-2xl"></i>
                </div>
            </div>
        </div>
        
        <!-- Total Traffic -->
        <div class="bg-white rounded-lg shadow p-6">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-gray-500 text-sm">总流量</p>
                    <p class="text-lg font-bold text-gray-600 mt-2">
                        <span class="text-orange-500">↑</span> <span x-text="metrics.network?.total_sent_formatted || '0 B'"></span>
                    </p>
                    <p class="text-lg font-bold text-gray-600">
                        <span class="text-cyan-500">↓</span> <span x-text="metrics.network?.total_recv_formatted || '0 B'"></span>
                    </p>
                </div>
                <div class="bg-gray-100 rounded-full p-3">
                    <i class="fas fa-exchange-alt text-gray-600 text-2xl"></i>
                </div>
            </div>
        </div>
    </div>
    
    <!-- sing-box Service Status Card -->
    <div class="bg-white rounded-lg shadow mb-6">
        <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center">
            <h3 class="text-lg font-semibold text-gray-800">sing-box 服务状态</h3>
            <button 
                @click="loadSystemStatus()"
                class="text-gray-500 hover:text-gray-700"
                title="刷新状态"
            >
                <i class="fas fa-sync-alt"></i>
            </button>
        </div>
        <div class="p-6">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <div 
                        class="w-16 h-16 rounded-full flex items-center justify-center"
                        :class="systemStatus.singbox?.running ? 'bg-green-100' : 'bg-red-100'"
                    >
                        <i 
                            class="text-3xl"
                            :class="systemStatus.singbox?.running ? 'fas fa-check-circle text-green-600' : 'fas fa-times-circle text-red-600'"
                        ></i>
                    </div>
                    <div>
                        <p class="text-lg font-semibold text-gray-800">
                            <span x-text="systemStatus.singbox?.running ? '运行中' : '未运行'"></span>
                        </p>
                        <p class="text-sm text-gray-600">
                            状态: <span x-text="systemStatus.singbox?.status || 'unknown'"></span>
                        </p>
                        <p class="text-sm text-gray-600">
                            版本: <span x-text="systemStatus.singbox?.version || 'unknown'"></span>
                        </p>
                        <template x-if="systemStatus.singbox?.enabled">
                            <p class="text-xs text-green-600 mt-1">
                                <i class="fas fa-check mr-1"></i>开机自启已启用
                            </p>
                        </template>
                    </div>
                </div>
                <div class="flex space-x-2">
                    <template x-if="!systemStatus.singbox?.running">
                        <button 
                            @click="startSingbox()"
                            :disabled="singboxLoading"
                            class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg disabled:opacity-50 disabled:cursor-not-allowed"
                        >
                            <i class="fas fa-play mr-2"></i>
                            <span x-show="!singboxLoading">启动</span>
                            <span x-show="singboxLoading">
                                <i class="fas fa-spinner fa-spin"></i>
                            </span>
                        </button>
                    </template>
                    <template x-if="systemStatus.singbox?.running">
                        <button 
                            @click="stopSingbox()"
                            :disabled="singboxLoading"
                            class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg disabled:opacity-50 disabled:cursor-not-allowed"
                        >
                            <i class="fas fa-stop mr-2"></i>
                            <span x-show="!singboxLoading">停止</span>
                            <span x-show="singboxLoading">
                                <i class="fas fa-spinner fa-spin"></i>
                            </span>
                        </button>
                        <button 
                            @click="restartSingbox()"
                            :disabled="singboxLoading"
                            class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg disabled:opacity-50 disabled:cursor-not-allowed"
                        >
                            <i class="fas fa-redo mr-2"></i>
                            <span x-show="!singboxLoading">重启</span>
                            <span x-show="singboxLoading">
                                <i class="fas fa-spinner fa-spin"></i>
                            </span>
                        </button>
                    </template>
                </div>
            </div>
            <template x-if="systemStatus.singbox?.error">
                <div class="mt-4 p-3 bg-red-50 border border-red-200 rounded-lg">
                    <p class="text-sm text-red-600">
                        <i class="fas fa-exclamation-triangle mr-2"></i>
                        <span x-text="systemStatus.singbox.error"></span>
                    </p>
                </div>
            </template>
        </div>
    </div>
    
    <!-- Proxy Status Table -->
    <div class="bg-white rounded-lg shadow mb-6">
        <div class="px-6 py-4 border-b border-gray-200">
            <h3 class="text-lg font-semibold text-gray-800">代理端口状态</h3>
        </div>
        <div class="overflow-x-auto">
            <table class="w-full">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">端口</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">名称</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">上游代理</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">连接数</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">监控状态</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">健康状态</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">最后检查</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    <template x-if="proxies.length === 0">
                        <tr>
                            <td colspan="7" class="px-6 py-8 text-center text-gray-500">
                                <i class="fas fa-inbox text-4xl mb-2"></i>
                                <p>暂无代理配置</p>
                            </td>
                        </tr>
                    </template>
                    
                    <template x-for="proxy in proxies" :key="proxy.local_port">
                        <tr class="hover:bg-gray-50">
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span class="text-sm font-medium text-gray-900" x-text="proxy.local_port"></span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span class="text-sm text-gray-900" x-text="proxy.name"></span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <template x-if="proxy.upstream">
                                    <span class="text-sm text-gray-600" x-text="proxy.upstream.server + ':' + proxy.upstream.port"></span>
                                </template>
                                <template x-if="!proxy.upstream">
                                    <span class="text-sm text-gray-400">直连模式</span>
                                </template>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span class="px-2 py-1 text-xs font-semibold rounded-full bg-purple-100 text-purple-800" 
                                      x-text="(systemStatus.port_connections && systemStatus.port_connections[proxy.local_port]) || 0"></span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span 
                                    class="px-2 py-1 text-xs font-semibold rounded-full"
                                    :class="proxy.monitoring_enabled ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'"
                                    x-text="proxy.monitoring_enabled ? '监控中' : '未监控'"
                                ></span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <template x-if="proxy.monitoring_status && proxy.monitoring_status.enabled">
                                    <span 
                                        class="px-2 py-1 text-xs font-semibold rounded-full"
                                        :class="proxy.monitoring_status.failure_count === 0 ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'"
                                        x-text="proxy.monitoring_status.failure_count === 0 ? '健康' : '异常 (' + proxy.monitoring_status.failure_count + ')'"
                                    ></span>
                                </template>
                                <template x-if="!proxy.monitoring_status || !proxy.monitoring_status.enabled">
                                    <span class="text-sm text-gray-400">-</span>
                                </template>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">
                                <template x-if="proxy.monitoring_status && proxy.monitoring_status.last_check_time">
                                    <span x-text="formatTime(proxy.monitoring_status.last_check_time)"></span>
                                </template>
                                <template x-if="!proxy.monitoring_status || !proxy.monitoring_status.last_check_time">
                                    <span class="text-gray-400">-</span>
                                </template>
                            </td>
                        </tr>
                    </template>
                </tbody>
            </table>
        </div>
    </div>
    
    <!-- Recent Switch History -->
    <div class="bg-white rounded-lg shadow">
        <div class="px-6 py-4 border-b border-gray-200">
            <h3 class="text-lg font-semibold text-gray-800">最近切换记录</h3>
        </div>
        <div class="overflow-x-auto">
            <table class="w-full">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">时间</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">端口</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">旧代理</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">新代理</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">原因</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">状态</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    <template x-if="history.length === 0">
                        <tr>
                            <td colspan="6" class="px-6 py-8 text-center text-gray-500">
                                <i class="fas fa-history text-4xl mb-2"></i>
                                <p>暂无切换记录</p>
                            </td>
                        </tr>
                    </template>
                    
                    <template x-for="entry in history" :key="entry.id">
                        <tr class="hover:bg-gray-50">
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">
                                <span x-text="formatTime(entry.timestamp)"></span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span class="text-sm font-medium text-gray-900" x-text="entry.local_port"></span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">
                                <template x-if="entry.old_upstream">
                                    <span x-text="entry.old_upstream.server + ':' + entry.old_upstream.port"></span>
                                </template>
                                <template x-if="!entry.old_upstream">
                                    <span class="text-gray-400">-</span>
                                </template>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">
                                <span x-text="entry.new_upstream.server + ':' + entry.new_upstream.port"></span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span 
                                    class="px-2 py-1 text-xs font-semibold rounded-full"
                                    :class="{
                                        'bg-yellow-100 text-yellow-800': entry.reason === 'health_check_failed',
                                        'bg-blue-100 text-blue-800': entry.reason === 'manual',
                                        'bg-red-100 text-red-800': entry.reason === 'api_error'
                                    }"
                                    x-text="getReasonText(entry.reason)"
                                ></span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span 
                                    class="px-2 py-1 text-xs font-semibold rounded-full"
                                    :class="entry.success ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'"
                                    x-text="entry.success ? '成功' : '失败'"
                                ></span>
                            </td>
                        </tr>
                    </template>
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function dashboardData() {
    return {
        systemStatus: {},
        metrics: {},
        proxies: [],
        history: [],
        singboxLoading: false,
        
        async init() {
            await this.loadSystemStatus();
            await this.loadProxies();
            await this.loadHistory();
            
            // 系统状态刷新（每30秒）
            setInterval(() => {
                this.loadSystemStatus();
                this.loadProxies();
                this.loadHistory();
            }, 30000);
            
            // 网络指标刷新（每3秒）
            setInterval(() => {
                this.loadMetrics();
            }, 3000);
        },
        
        async loadSystemStatus() {
            try {
                const response = await fetch('/api/system/status');
                if (response.ok) {
                    this.systemStatus = await response.json();
                    // 同步 metrics 数据
                    if (this.systemStatus.metrics) {
                        this.metrics = this.systemStatus.metrics;
                    }
                }
            } catch (error) {
                console.error('Failed to load system status:', error);
            }
        },
        
        async loadMetrics() {
            try {
                const response = await fetch('/api/system/metrics');
                if (response.ok) {
                    this.metrics = await response.json();
                }
            } catch (error) {
                console.error('Failed to load metrics:', error);
            }
        },
        
        async loadProxies() {
            try {
                const response = await fetch('/api/proxies');
                if (response.ok) {
                    const data = await response.json();
                    this.proxies = data.proxies || [];
                }
            } catch (error) {
                console.error('Failed to load proxies:', error);
            }
        },
        
        async loadHistory() {
            try {
                const response = await fetch('/api/history?limit=10');
                if (response.ok) {
                    const data = await response.json();
                    this.history = data.history || [];
                }
            } catch (error) {
                console.error('Failed to load history:', error);
            }
        },
        
        async startSingbox() {
            this.singboxLoading = true;
            try {
                const response = await fetch('/api/system/singbox/start', {
                    method: 'POST'
                });
                
                if (response.ok) {
                    const data = await response.json();
                    this.notify(data.message || 'sing-box 服务启动成功', 'success');
                    await this.loadSystemStatus();
                } else {
                    const error = await response.json();
                    this.notify(error.detail || '启动失败', 'error');
                }
            } catch (error) {
                console.error('Failed to start sing-box:', error);
                this.notify('启动失败', 'error');
            } finally {
                this.singboxLoading = false;
            }
        },
        
        async stopSingbox() {
            if (!confirm('确定要停止 sing-box 服务吗？这将中断所有代理连接。')) {
                return;
            }
            
            this.singboxLoading = true;
            try {
                const response = await fetch('/api/system/singbox/stop', {
                    method: 'POST'
                });
                
                if (response.ok) {
                    const data = await response.json();
                    this.notify(data.message || 'sing-box 服务已停止', 'success');
                    await this.loadSystemStatus();
                } else {
                    const error = await response.json();
                    this.notify(error.detail || '停止失败', 'error');
                }
            } catch (error) {
                console.error('Failed to stop sing-box:', error);
                this.notify('停止失败', 'error');
            } finally {
                this.singboxLoading = false;
            }
        },
        
        async restartSingbox() {
            if (!confirm('确定要重启 sing-box 服务吗？这将短暂中断所有代理连接。')) {
                return;
            }
            
            this.singboxLoading = true;
            try {
                const response = await fetch('/api/system/singbox/restart', {
                    method: 'POST'
                });
                
                if (response.ok) {
                    const data = await response.json();
                    this.notify(data.message || 'sing-box 服务重启成功', 'success');
                    await this.loadSystemStatus();
                } else {
                    const error = await response.json();
                    this.notify(error.detail || '重启失败', 'error');
                }
            } catch (error) {
                console.error('Failed to restart sing-box:', error);
                this.notify('重启失败', 'error');
            } finally {
                this.singboxLoading = false;
            }
        },
        
        formatTime(timestamp) {
            if (!timestamp) return '-';
            const date = new Date(timestamp);
            return date.toLocaleString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
        },
        
        getReasonText(reason) {
            const reasons = {
                'health_check_failed': '健康检查失败',
                'manual': '手动切换',
                'api_error': 'API错误'
            };
            return reasons[reason] || reason;
        },
        
        notify(message, type = 'success') {
            window.dispatchEvent(new CustomEvent('notify', {
                detail: { message, type }
            }));
        }
    };
}
</script>
{% endblock %}
