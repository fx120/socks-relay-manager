{% extends "base.html" %}

{% block title %}系统设置 - 代理中转系统{% endblock %}

{% block content %}
<div x-data="settingsData()" x-init="init()">
    <!-- Page Header -->
    <div class="mb-6">
        <h2 class="text-3xl font-bold text-gray-800">系统设置</h2>
        <p class="text-gray-600 mt-1">配置系统参数和监控设置</p>
    </div>
    
    <!-- Monitoring Settings -->
    <div class="bg-white rounded-lg shadow mb-6">
        <div class="px-6 py-4 border-b border-gray-200">
            <h3 class="text-lg font-semibold text-gray-800">监控参数配置</h3>
        </div>
        <div class="px-6 py-6">
            <form @submit.prevent="saveMonitoringSettings()" class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">
                            检查间隔（秒） *
                            <span class="text-xs text-gray-500 ml-1">健康检查的时间间隔</span>
                        </label>
                        <input 
                            type="number" 
                            x-model="monitoringSettings.check_interval"
                            min="5"
                            max="300"
                            required
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        >
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">
                            失败阈值（次） *
                            <span class="text-xs text-gray-500 ml-1">触发切换的连续失败次数</span>
                        </label>
                        <input 
                            type="number" 
                            x-model="monitoringSettings.failure_threshold"
                            min="1"
                            max="10"
                            required
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        >
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">
                            检查超时（秒） *
                            <span class="text-xs text-gray-500 ml-1">单次健康检查的超时时间</span>
                        </label>
                        <input 
                            type="number" 
                            x-model="monitoringSettings.check_timeout"
                            min="1"
                            max="60"
                            required
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        >
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">
                            检查URL *
                            <span class="text-xs text-gray-500 ml-1">用于健康检查的目标URL</span>
                        </label>
                        <input 
                            type="url" 
                            x-model="monitoringSettings.check_url"
                            required
                            placeholder="http://www.google.com"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        >
                    </div>
                </div>
                
                <div class="flex justify-end pt-4 border-t border-gray-200">
                    <button 
                        type="submit"
                        class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg"
                        :disabled="savingMonitoring"
                    >
                        <span x-show="!savingMonitoring">
                            <i class="fas fa-save mr-2"></i>
                            保存监控设置
                        </span>
                        <span x-show="savingMonitoring">
                            <i class="fas fa-spinner fa-spin mr-2"></i>
                            保存中...
                        </span>
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- System Settings -->
    <div class="bg-white rounded-lg shadow mb-6">
        <div class="px-6 py-4 border-b border-gray-200">
            <h3 class="text-lg font-semibold text-gray-800">系统配置</h3>
        </div>
        <div class="px-6 py-6">
            <form @submit.prevent="saveSystemSettings()" class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">
                            Web端口 *
                            <span class="text-xs text-gray-500 ml-1">Web管理界面的端口</span>
                        </label>
                        <input 
                            type="number" 
                            x-model="systemSettings.web_port"
                            min="1024"
                            max="65535"
                            required
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        >
                        <p class="text-xs text-yellow-600 mt-1">
                            <i class="fas fa-exclamation-triangle mr-1"></i>
                            修改端口后需要重启服务
                        </p>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">
                            日志级别 *
                            <span class="text-xs text-gray-500 ml-1">系统日志的详细程度</span>
                        </label>
                        <select 
                            x-model="systemSettings.log_level"
                            required
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        >
                            <option value="DEBUG">DEBUG - 调试信息</option>
                            <option value="INFO">INFO - 一般信息</option>
                            <option value="WARNING">WARNING - 警告信息</option>
                            <option value="ERROR">ERROR - 错误信息</option>
                        </select>
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">
                        日志文件路径 *
                        <span class="text-xs text-gray-500 ml-1">日志文件的存储位置</span>
                    </label>
                    <input 
                        type="text" 
                        x-model="systemSettings.log_file"
                        required
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    >
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">
                        数据库路径 *
                        <span class="text-xs text-gray-500 ml-1">SQLite数据库文件的位置</span>
                    </label>
                    <input 
                        type="text" 
                        x-model="systemSettings.database"
                        required
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    >
                </div>
                
                <div class="flex justify-end pt-4 border-t border-gray-200">
                    <button 
                        type="submit"
                        class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg"
                        :disabled="savingSystem"
                    >
                        <span x-show="!savingSystem">
                            <i class="fas fa-save mr-2"></i>
                            保存系统设置
                        </span>
                        <span x-show="savingSystem">
                            <i class="fas fa-spinner fa-spin mr-2"></i>
                            保存中...
                        </span>
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- System Information -->
    <div class="bg-white rounded-lg shadow">
        <div class="px-6 py-4 border-b border-gray-200">
            <h3 class="text-lg font-semibold text-gray-800">系统信息</h3>
        </div>
        <div class="px-6 py-6">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">系统状态</label>
                    <div class="flex items-center">
                        <span class="flex items-center text-green-600">
                            <i class="fas fa-circle text-xs mr-2"></i>
                            运行中
                        </span>
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">版本信息</label>
                    <div class="text-gray-900">v1.0.0</div>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">代理总数</label>
                    <div class="text-gray-900" x-text="systemInfo.total_proxies || 0"></div>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">监控中代理</label>
                    <div class="text-gray-900" x-text="systemInfo.active_monitoring || 0"></div>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">健康代理</label>
                    <div class="text-green-600 font-semibold" x-text="systemInfo.healthy_proxies || 0"></div>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">异常代理</label>
                    <div class="text-red-600 font-semibold" x-text="systemInfo.unhealthy_proxies || 0"></div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function settingsData() {
    return {
        monitoringSettings: {
            check_interval: 30,
            failure_threshold: 3,
            check_timeout: 10,
            check_url: 'http://www.google.com'
        },
        systemSettings: {
            web_port: 8080,
            log_level: 'INFO',
            log_file: '/var/log/proxy-relay/app.log',
            database: '/var/lib/proxy-relay/data.db'
        },
        systemInfo: {},
        savingMonitoring: false,
        savingSystem: false,
        
        async init() {
            await this.loadConfig();
            await this.loadSystemInfo();
        },
        
        async loadConfig() {
            try {
                const response = await fetch('/api/config');
                if (response.ok) {
                    const data = await response.json();
                    
                    if (data.monitoring) {
                        this.monitoringSettings = {
                            check_interval: data.monitoring.check_interval,
                            failure_threshold: data.monitoring.failure_threshold,
                            check_timeout: data.monitoring.check_timeout,
                            check_url: data.monitoring.check_url
                        };
                    }
                    
                    if (data.system) {
                        this.systemSettings = {
                            web_port: data.system.web_port,
                            log_level: data.system.log_level,
                            log_file: data.system.log_file,
                            database: data.system.database
                        };
                    }
                }
            } catch (error) {
                console.error('Failed to load config:', error);
                this.notify('加载配置失败', 'error');
            }
        },
        
        async loadSystemInfo() {
            try {
                const response = await fetch('/api/system/status');
                if (response.ok) {
                    this.systemInfo = await response.json();
                }
            } catch (error) {
                console.error('Failed to load system info:', error);
            }
        },
        
        async saveMonitoringSettings() {
            this.savingMonitoring = true;
            
            try {
                const response = await fetch('/api/config', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        monitoring: this.monitoringSettings
                    })
                });
                
                if (response.ok) {
                    this.notify('监控设置保存成功', 'success');
                    await this.loadConfig();
                } else {
                    const error = await response.json();
                    this.notify(error.detail || '保存失败', 'error');
                }
            } catch (error) {
                console.error('Failed to save monitoring settings:', error);
                this.notify('保存失败', 'error');
            } finally {
                this.savingMonitoring = false;
            }
        },
        
        async saveSystemSettings() {
            this.savingSystem = true;
            
            try {
                const response = await fetch('/api/config', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        system: this.systemSettings
                    })
                });
                
                if (response.ok) {
                    this.notify('系统设置保存成功', 'success');
                    await this.loadConfig();
                    
                    // 提示用户重启服务
                    if (this.systemSettings.web_port !== this.systemInfo.config?.web_port) {
                        this.notify('端口已修改，请重启服务使其生效', 'warning');
                    }
                } else {
                    const error = await response.json();
                    this.notify(error.detail || '保存失败', 'error');
                }
            } catch (error) {
                console.error('Failed to save system settings:', error);
                this.notify('保存失败', 'error');
            } finally {
                this.savingSystem = false;
            }
        },
        
        notify(message, type = 'success') {
            window.dispatchEvent(new CustomEvent('notify', {
                detail: { message, type }
            }));
        }
    };
}
</script>
{% endblock %}
